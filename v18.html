<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>World Quiz</title>
<link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f30d.png">
<style>
    :root { 
        --primary: #94a3b8; 
        --correct: #004225; 
        --wrong: #C80815;   
        --bg-grad: linear-gradient(180deg, #18181b, #27272a);
        --card-bg: #27272a;
        --border: #3f3f46;
        --bar-bg: #3f3f46;
        --aura-green: #1a8d57;
    }

    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-grad);
        color: #e4e4e7;
        min-height: 100vh; 
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
        padding-bottom: 60px;
    }

    /* RED VIGNETTE (DAMAGE) */
    #vignette {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 999;
        background: radial-gradient(circle, transparent 40%, rgba(160, 10, 10, 0.9));
        opacity: 0; transition: opacity 0.3s;
    }
    .throb { animation: throbAnim 1.2s ease-out; }
    @keyframes throbAnim {
        0% { opacity: 0; }
        15% { opacity: 1; }
        50% { opacity: 0.6; }
        80% { opacity: 0.9; }
        100% { opacity: 0; }
    }

    /* YELLOW VIGNETTE (COMBO) */
    #combo-vignette {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        pointer-events: none; z-index: 998; /* Under red */
        /* Faint yellow edges */
        background: radial-gradient(circle, transparent 50%, rgba(255, 220, 50, 0.25));
        opacity: 0; 
        transition: opacity 0.4s ease;
    }
    #combo-vignette.active { opacity: 1; }
    
    /* Pulse brighter on combo increase */
    .combo-pulse { animation: pulseYellow 0.3s ease-out; }
    
    @keyframes pulseYellow {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.5; filter: brightness(1.5); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* VICTORY OVERLAY */
    #victory-screen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        z-index: 2000;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(10px);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0; transition: opacity 0.5s;
    }
    #victory-screen.show { display: flex; opacity: 1; }
    
    .win-gif {
        width: 280px; height: 280px; object-fit: cover;
        border-radius: 20px; box-shadow: 0 0 50px rgba(72, 255, 140, 0.4);
        margin-bottom: 30px;
    }
    .win-title { font-size: 2.5rem; font-weight: 900; color: #fff; margin-bottom: 10px; }
    .win-sub { font-size: 1.2rem; color: #a1a1aa; margin-bottom: 40px; }
    
    .restart-btn {
        padding: 15px 40px; border-radius: 50px; border: none;
        background: var(--aura-green); color: #004225;
        font-size: 1.1rem; font-weight: 800; cursor: pointer;
        box-shadow: 0 0 20px rgba(72, 255, 140, 0.6);
        transition: transform 0.2s;
    }
    .restart-btn:active { transform: scale(0.95); }

    /* NAV BAR */
    .nav { 
        position: sticky; top: 0;
        width: 100%; max-width: 480px; 
        padding: 10px 20px; 
        display: flex; gap: 12px; 
        box-sizing: border-box; z-index: 100;
        background: rgba(24, 24, 27, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
    }
    .nav-btn {
        flex: 1; padding: 12px; border-radius: 10px;
        background: transparent; border: 1px solid var(--border);
        color: #71717a; font-weight: 700; font-size: 0.85rem; cursor: pointer;
        transition: 0.2s;
    }
    .nav-btn.active { background: #3f3f46; color: #fff; border-color: #52525b; }

    .main-container {
        width: 100%; max-width: 460px; 
        padding: 20px 24px;
        box-sizing: border-box;
        display: flex; flex-direction: column;
    }

    /* PROGRESS BAR */
    .progress-track {
        width: 100%;
        height: 16px; 
        background: var(--bar-bg);
        border-radius: 8px;
        margin-bottom: 25px;
        position: relative;
        overflow: hidden; 
        transform: translateZ(0); 
        -webkit-mask-image: -webkit-radial-gradient(white, black);
    }
    
    .progress-fill {
        height: 100%;
        width: 0%;
        background: var(--correct);
        transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s, opacity 0.2s;
        position: relative; 
        z-index: 5;
        opacity: 0; 
        overflow: visible; 
    }
    .progress-fill.visible { opacity: 1; }

    /* Draining State */
    .progress-fill.draining {
        background: var(--wrong) !important;
        width: 0% !important;
        opacity: 0; 
        transition: width 0.6s ease-out, opacity 0.6s ease-in;
    }

    /* NESTED AURA */
    .progress-aura {
        position: absolute;
        top: 0; bottom: 0;
        left: 100%; 
        width: 150px; 
        background: linear-gradient(to right, var(--aura-green), transparent);
        filter: blur(8px); 
        z-index: 6; 
        opacity: 0;
        pointer-events: none;
        transform-origin: left center;
        mix-blend-mode: screen; 
    }
    
    .aura-shoot { animation: softPulse 1.6s ease-out forwards; }
    
    @keyframes softPulse {
        0% { opacity: 0.8; transform: scaleX(0); } 
        30% { opacity: 1; transform: scaleX(0.7); } 
        100% { opacity: 0; transform: scaleX(1.5); } 
    }

    .progress-text {
        text-align: right; font-size: 0.75rem; color: #71717a; 
        font-weight: 700; margin-top: -22px; margin-bottom: 20px;
    }

    .view { display: none; flex-direction: column; width: 100%; align-items: center; }
    .view.active { display: flex; }
    
    .flag-icon { 
        font-size: 4.5rem; line-height: 1; text-align: center; display: block; 
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); margin: 0 auto;
    }
    
    .country-name { 
        font-size: 1.6rem; font-weight: 800; text-align: center; 
        margin: 15px 0 30px 0; line-height: 1.1; width: 100%;
        color: #fff;
    }

    .opts-container { width: 100%; display: flex; flex-direction: column; gap: 12px; }

    .opt-btn {
        position: relative; width: 100%; padding: 16px; 
        border-radius: 14px; font-size: 0.95rem; color: #e4e4e7; font-weight: 600;
        text-align: center; cursor: pointer; overflow: hidden;
        border: 1px solid var(--border);
        background: var(--card-bg);
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        box-sizing: border-box;
        transition: background-color 0.1s;
    }

    @keyframes popClick {
        0% { transform: scale(1); }
        50% { transform: scale(0.92); }
        100% { transform: scale(1); }
    }
    .pop-anim { animation: popClick 0.2s ease-out forwards; }

    .opt-btn.correct { border-color: var(--correct); background: var(--correct); }
    .opt-btn.wrong { border-color: var(--wrong); background: var(--wrong); }
    .shake { animation: quickShake 0.4s ease-in-out both; }
    
    @keyframes quickShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }

    .search { 
        width: 100%; padding: 14px; margin-bottom: 15px; 
        border-radius: 10px; color: white; 
        background: var(--card-bg); border: 1px solid var(--border); 
        font-size: 0.95rem; box-sizing: border-box; outline: none;
    }
    .row { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 14px 0; border-bottom: 1px solid var(--border); width: 100%;
    }
    .row-left { display: flex; align-items: center; gap: 16px; flex: 1; }
    .row-flag { font-size: 1.8rem; min-width: 40px; text-align: center; }
    .row-country { font-weight: 600; font-size: 0.95rem; color: #e4e4e7; }
    .row-right { text-align: right; }
    .row-cap { font-size: 0.9rem; color: #a1a1aa; font-weight: 500; }

</style>
</head>
<body>

<div id="vignette"></div>
<div id="combo-vignette"></div> <div id="victory-screen">
    <img src="victory.gif" class="win-gif" alt="Victory">
    <div class="win-title">COMPLETED!</div>
    <div class="win-sub">You conquered the world.</div>
    <button class="restart-btn" onclick="restartGame()">PLAY AGAIN</button>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="tab('quiz')">QUIZ</button>
    <button class="nav-btn" onclick="tab('study')">STUDY</button>
</div>

<div class="main-container">
    <div id="prog-container">
        <div class="progress-track">
            <div class="progress-fill" id="prog-bar">
                <div class="progress-aura" id="prog-aura"></div>
            </div>
        </div>
        <div class="progress-text" id="prog-text">0 / 197</div>
    </div>

    <div id="quiz-view" class="view active">
        <div class="flag-icon" id="q-flag">üåç</div>
        <div class="country-name" id="q-text">Loading...</div>
        <div id="opts" class="opts-container"></div>
    </div>

    <div id="study-view" class="view">
        <input type="text" id="search" class="search" placeholder="Search..." onkeyup="filter()">
        <div id="list" style="width:100%"></div>
    </div>
</div>

<script>
// --- DATA WITH REGIONS ---
// AF=Africa, AS=Asia, EU=Europe, NA=North America, SA=South America, OC=Oceania
const d=[
{c:"Afghanistan",k:"Kabul",f:"üá¶üá´",r:"AS"},{c:"Albania",k:"Tirana",f:"üá¶üá±",r:"EU"},{c:"Algeria",k:"Algiers",f:"üá©üáø",r:"AF"},{c:"Andorra",k:"Andorra la Vella",f:"üá¶üá©",r:"EU"},{c:"Angola",k:"Luanda",f:"üá¶üá¥",r:"AF"},
{c:"Antigua & Barbuda",k:"Saint John's",f:"üá¶üá¨",r:"NA"},{c:"Argentina",k:"Buenos Aires",f:"üá¶üá∑",r:"SA"},{c:"Armenia",k:"Yerevan",f:"üá¶üá≤",r:"AS"},{c:"Australia",k:"Canberra",f:"üá¶üá∫",r:"OC"},{c:"Austria",k:"Vienna",f:"üá¶üáπ",r:"EU"},
{c:"Azerbaijan",k:"Baku",f:"üá¶üáø",r:"AS"},{c:"Bahamas",k:"Nassau",f:"üáßüá∏",r:"NA"},{c:"Bahrain",k:"Manama",f:"üáßüá≠",r:"AS"},{c:"Bangladesh",k:"Dhaka",f:"üáßüá©",r:"AS"},{c:"Barbados",k:"Bridgetown",f:"üáßüáß",r:"NA"},
{c:"Belarus",k:"Minsk",f:"üáßüáæ",r:"EU"},{c:"Belgium",k:"Brussels",f:"üáßüá™",r:"EU"},{c:"Belize",k:"Belmopan",f:"üáßüáø",r:"NA"},{c:"Benin",k:"Porto-Novo",f:"üáßüáØ",r:"AF"},{c:"Bhutan",k:"Thimphu",f:"üáßüáπ",r:"AS"},
{c:"Bolivia",k:"Sucre",f:"üáßüá¥",r:"SA"},{c:"Bosnia & Herzegovina",k:"Sarajevo",f:"üáßüá¶",r:"EU"},{c:"Botswana",k:"Gaborone",f:"üáßüáº",r:"AF"},{c:"Brazil",k:"Bras√≠lia",f:"üáßüá∑",r:"SA"},{c:"Brunei",k:"Bandar Seri Begawan",f:"üáßüá≥",r:"AS"},
{c:"Bulgaria",k:"Sofia",f:"üáßüá¨",r:"EU"},{c:"Burkina Faso",k:"Ouagadougou",f:"üáßüá´",r:"AF"},{c:"Burundi",k:"Gitega",f:"üáßüáÆ",r:"AF"},{c:"Cabo Verde",k:"Praia",f:"üá®üáª",r:"AF"},{c:"Cambodia",k:"Phnom Penh",f:"üá∞üá≠",r:"AS"},
{c:"Cameroon",k:"Yaound√©",f:"üá®üá≤",r:"AF"},{c:"Canada",k:"Ottawa",f:"üá®üá¶",r:"NA"},{c:"Central African Rep.",k:"Bangui",f:"üá®üá´",r:"AF"},{c:"Chad",k:"N'Djamena",f:"üáπüá©",r:"AF"},{c:"Chile",k:"Santiago",f:"üá®üá±",r:"SA"},
{c:"China",k:"Beijing",f:"üá®üá≥",r:"AS"},{c:"Colombia",k:"Bogot√°",f:"üá®üá¥",r:"SA"},{c:"Comoros",k:"Moroni",f:"üá∞üá≤",r:"AF"},{c:"Congo (DRC)",k:"Kinshasa",f:"üá®üá©",r:"AF"},{c:"Congo (Rep.)",k:"Brazzaville",f:"üá®üá¨",r:"AF"},
{c:"Costa Rica",k:"San Jos√©",f:"üá®üá∑",r:"NA"},{c:"Croatia",k:"Zagreb",f:"üá≠üá∑",r:"EU"},{c:"Cuba",k:"Havana",f:"üá®üá∫",r:"NA"},{c:"Cyprus",k:"Nicosia",f:"üá®üáæ",r:"EU"},{c:"Czechia",k:"Prague",f:"üá®üáø",r:"EU"},
{c:"Denmark",k:"Copenhagen",f:"üá©üá∞",r:"EU"},{c:"Djibouti",k:"Djibouti",f:"üá©üáØ",r:"AF"},{c:"Dominica",k:"Roseau",f:"üá©üá≤",r:"NA"},{c:"Dominican Rep.",k:"Santo Domingo",f:"üá©üá¥",r:"NA"},{c:"East Timor",k:"Dili",f:"üáπüá±",r:"AS"},
{c:"Ecuador",k:"Quito",f:"üá™üá®",r:"SA"},{c:"Egypt",k:"Cairo",f:"üá™üá¨",r:"AF"},{c:"El Salvador",k:"San Salvador",f:"üá∏üáª",r:"NA"},{c:"Equatorial Guinea",k:"Malabo",f:"üá¨üá∂",r:"AF"},{c:"Eritrea",k:"Asmara",f:"üá™üá∑",r:"AF"},
{c:"Estonia",k:"Tallinn",f:"üá™üá™",r:"EU"},{c:"Eswatini",k:"Mbabane",f:"üá∏üáø",r:"AF"},{c:"Ethiopia",k:"Addis Ababa",f:"üá™üáπ",r:"AF"},{c:"Fiji",k:"Suva",f:"üá´üáØ",r:"OC"},{c:"Finland",k:"Helsinki",f:"üá´üáÆ",r:"EU"},
{c:"France",k:"Paris",f:"üá´üá∑",r:"EU"},{c:"Gabon",k:"Libreville",f:"üá¨üá¶",r:"AF"},{c:"Gambia",k:"Banjul",f:"üá¨üá≤",r:"AF"},{c:"Georgia",k:"Tbilisi",f:"üá¨üá™",r:"AS"},{c:"Germany",k:"Berlin",f:"üá©üá™",r:"EU"},
{c:"Ghana",k:"Accra",f:"üá¨üá≠",r:"AF"},{c:"Greece",k:"Athens",f:"üá¨üá∑",r:"EU"},{c:"Grenada",k:"St. George's",f:"üá¨üá©",r:"NA"},{c:"Guatemala",k:"Guatemala City",f:"üá¨üáπ",r:"NA"},{c:"Guinea",k:"Conakry",f:"üá¨üá≥",r:"AF"},
{c:"Guinea-Bissau",k:"Bissau",f:"üá¨üáº",r:"AF"},{c:"Guyana",k:"Georgetown",f:"üá¨üáæ",r:"SA"},{c:"Haiti",k:"Port-au-Prince",f:"üá≠üáπ",r:"NA"},{c:"Honduras",k:"Tegucigalpa",f:"üá≠üá≥",r:"NA"},{c:"Hungary",k:"Budapest",f:"üá≠üá∫",r:"EU"},
{c:"Iceland",k:"Reykjav√≠k",f:"üáÆüá∏",r:"EU"},{c:"India",k:"New Delhi",f:"üáÆüá≥",r:"AS"},{c:"Indonesia",k:"Jakarta",f:"üáÆüá©",r:"AS"},{c:"Iran",k:"Tehran",f:"üáÆüá∑",r:"AS"},{c:"Iraq",k:"Baghdad",f:"üáÆüá∂",r:"AS"},
{c:"Ireland",k:"Dublin",f:"üáÆüá™",r:"EU"},{c:"Israel",k:"Jerusalem",f:"üáÆüá±",r:"AS"},{c:"Italy",k:"Rome",f:"üáÆüáπ",r:"EU"},{c:"Ivory Coast",k:"Yamoussoukro",f:"üá®üáÆ",r:"AF"},{c:"Jamaica",k:"Kingston",f:"üáØüá≤",r:"NA"},
{c:"Japan",k:"Tokyo",f:"üáØüáµ",r:"AS"},{c:"Jordan",k:"Amman",f:"üáØüá¥",r:"AS"},{c:"Kazakhstan",k:"Astana",f:"üá∞üáø",r:"AS"},{c:"Kenya",k:"Nairobi",f:"üá∞üá™",r:"AF"},{c:"Kiribati",k:"Tarawa",f:"üá∞üáÆ",r:"OC"},
{c:"Kosovo",k:"Pristina",f:"üáΩüá∞",r:"EU"},{c:"Kuwait",k:"Kuwait City",f:"üá∞üáº",r:"AS"},{c:"Kyrgyzstan",k:"Bishkek",f:"üá∞üá¨",r:"AS"},{c:"Laos",k:"Vientiane",f:"üá±üá¶",r:"AS"},{c:"Latvia",k:"Riga",f:"üá±üáª",r:"EU"},
{c:"Lebanon",k:"Beirut",f:"üá±üáß",r:"AS"},{c:"Lesotho",k:"Maseru",f:"üá±üá∏",r:"AF"},{c:"Liberia",k:"Monrovia",f:"üá±üá∑",r:"AF"},{c:"Libya",k:"Tripoli",f:"üá±üáæ",r:"AF"},{c:"Liechtenstein",k:"Vaduz",f:"üá±üáÆ",r:"EU"},
{c:"Lithuania",k:"Vilnius",f:"üá±üáπ",r:"EU"},{c:"Luxembourg",k:"Luxembourg",f:"üá±üá∫",r:"EU"},{c:"Madagascar",k:"Antananarivo",f:"üá≤üá¨",r:"AF"},{c:"Malawi",k:"Lilongwe",f:"üá≤üáº",r:"AF"},{c:"Malaysia",k:"Kuala Lumpur",f:"üá≤üáæ",r:"AS"},
{c:"Maldives",k:"Mal√©",f:"üá≤üáª",r:"AS"},{c:"Mali",k:"Bamako",f:"üá≤üá±",r:"AF"},{c:"Malta",k:"Valletta",f:"üá≤üáπ",r:"EU"},{c:"Marshall Islands",k:"Majuro",f:"üá≤üá≠",r:"OC"},{c:"Mauritania",k:"Nouakchott",f:"üá≤üá∑",r:"AF"},
{c:"Mauritius",k:"Port Louis",f:"üá≤üá∫",r:"AF"},{c:"Mexico",k:"Mexico City",f:"üá≤üáΩ",r:"NA"},{c:"Micronesia",k:"Palikir",f:"üá´üá≤",r:"OC"},{c:"Moldova",k:"Chisinau",f:"üá≤üá©",r:"EU"},{c:"Monaco",k:"Monaco",f:"üá≤üá®",r:"EU"},
{c:"Mongolia",k:"Ulaanbaatar",f:"üá≤üá≥",r:"AS"},{c:"Montenegro",k:"Podgorica",f:"üá≤üá™",r:"EU"},{c:"Morocco",k:"Rabat",f:"üá≤üá¶",r:"AF"},{c:"Mozambique",k:"Maputo",f:"üá≤üáø",r:"AF"},{c:"Myanmar",k:"Naypyidaw",f:"üá≤üá≤",r:"AS"},
{c:"Namibia",k:"Windhoek",f:"üá≥üá¶",r:"AF"},{c:"Nauru",k:"Yaren",f:"üá≥üá∑",r:"OC"},{c:"Nepal",k:"Kathmandu",f:"üá≥üáµ",r:"AS"},{c:"Netherlands",k:"Amsterdam",f:"üá≥üá±",r:"EU"},{c:"New Zealand",k:"Wellington",f:"üá≥üáø",r:"OC"},
{c:"Nicaragua",k:"Managua",f:"üá≥üáÆ",r:"NA"},{c:"Niger",k:"Niamey",f:"üá≥üá™",r:"AF"},{c:"Nigeria",k:"Abuja",f:"üá≥üá¨",r:"AF"},{c:"North Korea",k:"Pyongyang",f:"üá∞üáµ",r:"AS"},{c:"North Macedonia",k:"Skopje",f:"üá≤üá∞",r:"EU"},
{c:"Norway",k:"Oslo",f:"üá≥üá¥",r:"EU"},{c:"Oman",k:"Muscat",f:"üá¥üá≤",r:"AS"},{c:"Pakistan",k:"Islamabad",f:"üáµüá∞",r:"AS"},{c:"Palau",k:"Ngerulmud",f:"üáµüáº",r:"OC"},{c:"Palestine",k:"Ramallah",f:"üáµüá∏",r:"AS"},
{c:"Panama",k:"Panama City",f:"üáµüá¶",r:"NA"},{c:"Papua New Guinea",k:"Port Moresby",f:"üáµüá¨",r:"OC"},{c:"Paraguay",k:"Asunci√≥n",f:"üáµüáæ",r:"SA"},{c:"Peru",k:"Lima",f:"üáµüá™",r:"SA"},{c:"Philippines",k:"Manila",f:"üáµüá≠",r:"AS"},
{c:"Poland",k:"Warsaw",f:"üáµüá±",r:"EU"},{c:"Portugal",k:"Lisbon",f:"üáµüáπ",r:"EU"},{c:"Qatar",k:"Doha",f:"üá∂üá¶",r:"AS"},{c:"Romania",k:"Bucharest",f:"üá∑üá¥",r:"EU"},{c:"Russia",k:"Moscow",f:"üá∑üá∫",r:"EU"},
{c:"Rwanda",k:"Kigali",f:"üá∑üáº",r:"AF"},{c:"St. Kitts & Nevis",k:"Basseterre",f:"üá∞üá≥",r:"NA"},{c:"St. Lucia",k:"Castries",f:"üá±üá®",r:"NA"},{c:"St. Vincent",k:"Kingstown",f:"üáªüá®",r:"NA"},{c:"Samoa",k:"Apia",f:"üáºüá∏",r:"OC"},
{c:"San Marino",k:"San Marino",f:"üá∏üá≤",r:"EU"},{c:"Sao Tome & Principe",k:"Sao Tome",f:"üá∏üáπ",r:"AF"},{c:"Saudi Arabia",k:"Riyadh",f:"üá∏üá¶",r:"AS"},{c:"Senegal",k:"Dakar",f:"üá∏üá≥",r:"AF"},{c:"Serbia",k:"Belgrade",f:"üá∑üá∏",r:"EU"},
{c:"Seychelles",k:"Victoria",f:"üá∏üá®",r:"AF"},{c:"Sierra Leone",k:"Freetown",f:"üá∏üá±",r:"AF"},{c:"Singapore",k:"Singapore",f:"üá∏üá¨",r:"AS"},{c:"Slovakia",k:"Bratislava",f:"üá∏üá∞",r:"EU"},{c:"Slovenia",k:"Ljubljana",f:"üá∏üáÆ",r:"EU"},
{c:"Solomon Islands",k:"Honiara",f:"üá∏üáß",r:"OC"},{c:"Somalia",k:"Mogadishu",f:"üá∏üá¥",r:"AF"},{c:"South Africa",k:"Pretoria",f:"üáøüá¶",r:"AF"},{c:"South Korea",k:"Seoul",f:"üá∞üá∑",r:"AS"},{c:"South Sudan",k:"Juba",f:"üá∏üá∏",r:"AF"},
{c:"Spain",k:"Madrid",f:"üá™üá∏",r:"EU"},{c:"Sri Lanka",k:"Colombo",f:"üá±üá∞",r:"AS"},{c:"Sudan",k:"Khartoum",f:"üá∏üá©",r:"AF"},{c:"Suriname",k:"Paramaribo",f:"üá∏üá∑",r:"SA"},{c:"Sweden",k:"Stockholm",f:"üá∏üá™",r:"EU"},
{c:"Switzerland",k:"Bern",f:"üá®üá≠",r:"EU"},{c:"Syria",k:"Damascus",f:"üá∏üáæ",r:"AS"},{c:"Taiwan",k:"Taipei",f:"üáπüáº",r:"AS"},{c:"Tajikistan",k:"Dushanbe",f:"üáπüáØ",r:"AS"},{c:"Tanzania",k:"Dodoma",f:"üáπüáø",r:"AF"},
{c:"Thailand",k:"Bangkok",f:"üáπüá≠",r:"AS"},{c:"Togo",k:"Lom√©",f:"üáπüá¨",r:"AF"},{c:"Tonga",k:"Nuku ªalofa",f:"üáπüá¥",r:"OC"},{c:"Trinidad & Tobago",k:"Port of Spain",f:"üáπüáπ",r:"NA"},{c:"Tunisia",k:"Tunis",f:"üáπüá≥",r:"AF"},
{c:"T√ºrkiye",k:"Ankara",f:"üáπüá∑",r:"AS"},{c:"Turkmenistan",k:"Ashgabat",f:"üáπüá≤",r:"AS"},{c:"Tuvalu",k:"Funafuti",f:"üáπüáª",r:"OC"},{c:"Uganda",k:"Kampala",f:"üá∫üá¨",r:"AF"},{c:"Ukraine",k:"Kyiv",f:"üá∫üá¶",r:"EU"},
{c:"UAE",k:"Abu Dhabi",f:"üá¶üá™",r:"AS"},{c:"United Kingdom",k:"London",f:"üá¨üáß",r:"EU"},{c:"United States",k:"Washington, D.C.",f:"üá∫üá∏",r:"NA"},{c:"Uruguay",k:"Montevideo",f:"üá∫üáæ",r:"SA"},{c:"Uzbekistan",k:"Tashkent",f:"üá∫üáø",r:"AS"},
{c:"Vanuatu",k:"Port Vila",f:"üáªüá∫",r:"OC"},{c:"Vatican City",k:"Vatican City",f:"üáªüá¶",r:"EU"},{c:"Venezuela",k:"Caracas",f:"üáªüá™",r:"SA"},{c:"Vietnam",k:"Hanoi",f:"üáªüá≥",r:"AS"},{c:"Yemen",k:"Sana'a",f:"üáæüá™",r:"AS"},
{c:"Zambia",k:"Lusaka",f:"üáøüá≤",r:"AF"},{c:"Zimbabwe",k:"Harare",f:"üáøüáº",r:"AF"}
];

// --- POLYPHONIC AUDIO SETUP ---
const soundFiles = {
    click:   'click.mp3',
    correct: 'correct.mp3',
    wrong:   'wrong.mp3',
    shatter: 'shatter.mp3',
    victory: 'victory.mp3',
    combo:   'combo.mp3'
};

const volumes = {
    click: 0.5,
    correct: 0.5,
    wrong: 0.5,
    shatter: 0.7,
    victory: 0.8,
    combo: 0.6
};

// Pre-load the "master" tracks
const masters = {};
for(let k in soundFiles) {
    const a = new Audio(soundFiles[k]);
    a.preload = 'auto'; 
    a.load();
    masters[k] = a;
}

// "Unlock" audio on first touch (Mobile Fix)
let audioUnlocked = false;
function unlockAudio() {
    if(audioUnlocked) return;
    
    for(let k in masters) {
        // 1. MUTE the master track before the warm-up play
        masters[k].muted = true; 
        
        masters[k].play().then(() => {
            // 2. Pause immediately
            masters[k].pause();
            masters[k].currentTime = 0;
            
            // 3. UNMUTE it so it's ready for the game
            masters[k].muted = false;
            masters[k].volume = volumes[k]; 
        }).catch(()=>{/*Ignore errors*/});
    }
    
    audioUnlocked = true;
    document.removeEventListener('click', unlockAudio);
    document.removeEventListener('touchstart', unlockAudio);
}

document.addEventListener('click', unlockAudio);
document.addEventListener('touchstart', unlockAudio);

function playSound(type, playbackRate = 1.0) {
    const master = masters[type];
    if(master) {
        const clone = master.cloneNode(); 
        // Ensure clone volume matches config
        clone.volume = volumes[type] || 0.5;
        // Ensure clone is not muted (just in case)
        clone.muted = false; 
        
        // Pitch/Speed Shift for Combo
        if(playbackRate !== 1.0) {
            clone.playbackRate = playbackRate;
            clone.preservesPitch = false; // Try to pitch shift (browser dependent)
        }
        
        clone.play().catch(e => console.warn('Audio blocked', e));
        clone.onended = () => { clone.remove(); };
    }
}
// -------------------

let pool = []; 
let streak = 0; 
let combo = 0; // Combo Counter
let qStart = 0; // Question Start Time
let cur = {};
let lock = false;

function resetDeck() { pool = [...d]; }
resetDeck();

function tab(t) {
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    document.getElementById(t+'-view').classList.add('active');
    document.querySelector(`button[onclick="tab('${t}')"]`).classList.add('active');
    
    document.getElementById('prog-container').style.display = (t==='quiz') ? 'block' : 'none';
    
    // Play subtle click sound on nav
    playSound('click');
    
    if(t==='study') renderList();
}

function loadQ() {
    try {
        lock=false;
        const con = document.getElementById('opts');
        con.innerHTML='';
        
        document.getElementById('prog-bar').classList.remove('draining', 'pulse-active');
        
        // --- VICTORY CHECK ---
        if(pool.length === 0 && streak === d.length) {
            triggerVictory();
            return;
        }
        
        if(pool.length === 0) resetDeck();
        const idx = Math.floor(Math.random() * pool.length);
        const q = pool[idx];
        pool.splice(idx, 1);
        
        cur = q;
        document.getElementById('q-text').innerText = q.c;
        document.getElementById('q-flag').innerText = q.f;
        
        // START TIMER
        qStart = Date.now();

        // NEW LOGIC: Filter distractors by Region (r)
        let sameRegion = d.filter(x => x.r === q.r && x.k !== q.k);
        sameRegion.sort(() => Math.random() - 0.5);
        let opts = sameRegion.slice(0, 3);
        opts.push(q);
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(o=>{
            let b = document.createElement('div');
            b.className = 'opt-btn';
            b.innerText = o.k;
            b.onclick = ()=>check(b, o.k);
            con.appendChild(b);
        });
        
    } catch(e) { alert("Data Load Error"); }
}

function check(btn, ans) {
    if(lock) return;
    lock = true;
    
    btn.classList.add('pop-anim');
    const elapsed = Date.now() - qStart; // Calculate time taken
    
    if(ans === cur.k) {
        // CORRECT
        btn.classList.add('correct');
        playSound('correct'); 
        streak++;
        if(navigator.vibrate) navigator.vibrate(10);
        
        // --- COMBO CHECK (< 3000ms) ---
        if(elapsed < 3000) {
            combo++;
            // Vignette Visuals
            const vig = document.getElementById('combo-vignette');
            vig.classList.add('active');
            vig.classList.remove('combo-pulse');
            void vig.offsetWidth; // Trigger reflow
            vig.classList.add('combo-pulse');
            
            // Audio Pitch Logic (Cap at 2.0x speed)
            let rate = 1.0 + (combo * 0.1);
            if(rate > 2.0) rate = 2.0;
            playSound('combo', rate);
        } else {
            // Correct but slow: Reset Combo
            combo = 0;
            document.getElementById('combo-vignette').classList.remove('active');
        }
        
        // SYNCED DELAY
        setTimeout(() => {
            updateBar(true); 
            // Check victory *after* bar update visually
            if(streak === d.length) {
                setTimeout(triggerVictory, 600);
            } else {
                setTimeout(loadQ, 600);
            }
        }, 250);

    } else {
        // WRONG
        btn.classList.add('wrong', 'shake');
        
        // BREAK COMBO
        combo = 0;
        document.getElementById('combo-vignette').classList.remove('active');
        
        // STREAK LOSS LOGIC
        if(streak > 10) {
            playSound('shatter'); // DRAMATIC SOUND
            document.getElementById('vignette').style.opacity = '1';
            document.getElementById('vignette').classList.add('throb');
            setTimeout(()=>{
                 document.getElementById('vignette').style.opacity = '0';
                 document.getElementById('vignette').classList.remove('throb');
            }, 1200);
            if(navigator.vibrate) navigator.vibrate(200); 
        } else {
            playSound('wrong'); // NORMAL SOUND
            if(navigator.vibrate) navigator.vibrate([40,40]);
        }

        document.querySelectorAll('.opt-btn').forEach(b=>{
            if(b.innerText === cur.k) b.classList.add('correct');
        });
        
        // SYNCED DELAY
        setTimeout(() => {
            streak=0;
            resetDeck();
            const bar = document.getElementById('prog-bar');
            bar.classList.add('draining');
            updateBar(false);
        }, 250);
        
        setTimeout(loadQ, 800);
    }
}

function triggerVictory() {
    playSound('victory');
    const screen = document.getElementById('victory-screen');
    screen.classList.add('show');
}

function restartGame() {
    streak = 0;
    combo = 0;
    document.getElementById('combo-vignette').classList.remove('active');
    resetDeck();
    updateBar(false);
    document.getElementById('victory-screen').classList.remove('show');
    const vic = masters['victory']; 
    vic.pause();
    vic.currentTime = 0;
    loadQ();
}

function updateBar(fireAura) {
    const pct = (streak / d.length) * 100;
    const bar = document.getElementById('prog-bar');
    const aura = document.getElementById('prog-aura');
    
    document.getElementById('prog-text').innerText = streak + ' / ' + d.length;

    if(streak === 0) {
        // ZERO STATE HARD RESET
        bar.style.width = '0%';
        bar.classList.remove('visible');
        // Ensure aura is killed instantly so no green shows at 0
        aura.classList.remove('aura-shoot');
        aura.style.opacity = '0'; 
    } else if(!bar.classList.contains('draining')) {
        bar.style.width = pct + '%';
        bar.classList.add('visible'); // Turns opacity to 1
        
        // Positioning logic is now CSS-based (nested div), just trigger animation
        if(fireAura) {
            aura.classList.remove('aura-shoot');
            void aura.offsetWidth; 
            aura.classList.add('aura-shoot');
        }
    }
}

let listDone = false;
function renderList() {
    if(listDone) return;
    const l = document.getElementById('list');
    l.innerHTML='';
    [...d].sort((a,b)=>a.c.localeCompare(b.c)).forEach(i=>{
        let r = document.createElement('div');
        r.className='row';
        r.innerHTML = `
            <div class="row-left">
                <span class="row-flag">${i.f}</span>
                <span class="row-country">${i.c}</span>
            </div>
            <div class="row-right">
                <span class="row-cap">${i.k}</span>
            </div>
        `;
        l.appendChild(r);
    });
    listDone=true;
}

function filter() {
    let v = document.getElementById('search').value.toLowerCase();
    document.querySelectorAll('.row').forEach(r=>{
        r.style.display = r.innerText.toLowerCase().includes(v) ? 'flex' : 'none';
    });
}

window.onload=function() {
    loadQ();
    updateBar(false);
};
</script>
</body>
</html>